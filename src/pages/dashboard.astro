---
import Layout from "../components/Layout.astro";
import { getUser } from "../lib/auth";

// Check authentication
const user = await getUser(Astro.request);

if (!user) {
  // Redirect to login if not authenticated
  return Astro.redirect('/api/auth/login');
}
---

<Layout title="Dashboard – AstroN00b">
  <div class="dashboard">
    <div class="dashboard-header">
      {user.picture && (
        <img src={user.picture} alt={user.username} class="profile-photo" />
      )}
      <h1>Welcome, {user.username}!</h1>
    </div>
    
    <section class="dashboard-section">
      <h2>Your Account</h2>
      <p><strong>Email:</strong> {user.email}</p>
      <p><strong>User ID:</strong> {user.userId}</p>
    </section>

    <section class="dashboard-section">
      <h2>Your Scopes</h2>
      <div id="scopes-container">
        <p>Loading scopes...</p>
      </div>
      <a href="/scopes/new" class="button">Add New Scope</a>
    </section>

    <section class="dashboard-section">
      <h2>Quick Links</h2>
      <ul>
        <li><a href="/tools/visibility">What's Up Tonight?</a></li>
        <li><a href="/tools/lst">Local Sidereal Time</a></li>
      </ul>
    </section>
  </div>
</Layout>

<style>
  .dashboard {
    max-width: 800px;
    margin: 2rem auto;
    padding: 0 1rem;
  }

  .dashboard-header {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    margin-bottom: 1rem;
  }

  .profile-photo {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: 3px solid var(--an-cyan);
    box-shadow: 0 0 15px rgba(105, 245, 255, 0.3);
    object-fit: cover;
  }

  .dashboard-section {
    background: rgba(10, 110, 136, 0.15); /* Semi-transparent blue matching your theme */
    border: 1px solid var(--an-blue);
    padding: 1.5rem;
    margin: 1.5rem 0;
    border-radius: 8px;
  }

  .dashboard-section h2 {
    margin-top: 0;
    font-size: 1.5rem;
    color: var(--an-cyan); /* Cyan accent for headings */
  }

  .dashboard-section p {
    color: var(--an-white); /* Ensure readable text */
  }

  .button {
    display: inline-block;
    padding: 0.75rem 1.5rem;
    background: var(--an-blue);
    color: var(--an-white);
    text-decoration: none;
    border-radius: 4px;
    border: 2px solid var(--an-cyan);
    transition: all 0.2s;
    font-weight: 600;
  }

  .button:hover:not(.disabled) {
    background: var(--an-cyan);
    color: var(--an-navy);
  }

  .button.disabled {
    background: #ccc;
    cursor: not-allowed;
    opacity: 0.6;
  }

  .dashboard-section ul {
    list-style: none;
    padding: 0;
  }

  .dashboard-section li {
    margin: 0.5rem 0;
  }

  .dashboard-section a {
    color: var(--an-pink);
    text-decoration: none;
  }

  .dashboard-section a:hover {
    color: var(--an-cyan);
    text-decoration: underline;
  }

  .scope-list {
    list-style: none;
    padding: 0;
    margin: 1rem 0;
  }

  .scope-item {
    background: rgba(10, 110, 136, 0.2);
    border: 1px solid rgba(105, 245, 255, 0.3);
    padding: 1rem;
    margin: 0.5rem 0;
    border-radius: 4px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .scope-info h3 {
    margin: 0 0 0.5rem 0;
    font-size: 1.2rem;
    color: var(--an-cyan);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .scope-info p {
    margin: 0.25rem 0;
    font-size: 0.9rem;
    color: var(--an-white);
  }

  .scope-status {
    color: var(--an-cyan) !important;
    font-weight: 500;
  }

  .status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    flex-shrink: 0;
  }

  .status-dot.green {
    background-color: #28a745;
    box-shadow: 0 0 8px rgba(40, 167, 69, 0.6);
  }

  .status-dot.yellow {
    background-color: #ffc107;
    box-shadow: 0 0 8px rgba(255, 193, 7, 0.6);
  }

  .status-dot.red {
    background-color: #dc3545;
    box-shadow: 0 0 8px rgba(220, 53, 69, 0.6);
  }

  .status-dot.gray {
    background-color: #6c757d;
    opacity: 0.5;
  }

  .scope-actions {
    display: flex;
    gap: 0.5rem;
  }

  .scope-actions a,
  .scope-actions button {
    padding: 0.5rem 1rem;
    text-decoration: none;
    border-radius: 4px;
    font-size: 0.9rem;
    border: 2px solid;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: 600;
  }

  .scope-actions a {
    background: var(--an-blue);
    color: var(--an-white);
    border-color: var(--an-cyan);
  }

  .scope-actions button {
    background: rgba(255, 45, 190, 0.2);
    color: var(--an-pink);
    border-color: var(--an-pink);
  }

  .scope-actions a:hover {
    background: var(--an-cyan);
    color: var(--an-navy);
    text-decoration: none;
  }

  .scope-actions button:hover {
    background: var(--an-pink);
    color: var(--an-navy);
  }
</style>

<script>
  import { formatDishSize } from '../lib/units';

  function formatTimeAgo(date: Date): string {
    const now = new Date();
    const diffMs = now.getTime() - date.getTime();
    const diffSeconds = Math.floor(diffMs / 1000);
    const diffMinutes = Math.floor(diffSeconds / 60);
    const diffHours = Math.floor(diffMinutes / 60);
    const diffDays = Math.floor(diffHours / 24);

    if (diffSeconds < 60) {
      return `${diffSeconds}s ago`;
    } else if (diffMinutes < 60) {
      return `${diffMinutes}m ago`;
    } else if (diffHours < 24) {
      return `${diffHours}h ago`;
    } else {
      return `${diffDays}d ago`;
    }
  }

  function getStatusDot(scope: any): string {
    if (!scope.lastHeartbeatAt) {
      return '<span class="status-dot gray" title="No heartbeat data"></span>';
    }

    const lastHeartbeat = new Date(scope.lastHeartbeatAt);
    const now = new Date();
    const diffSeconds = Math.floor((now.getTime() - lastHeartbeat.getTime()) / 1000);

    if (diffSeconds <= 60) {
      return '<span class="status-dot green" title="Online"></span>';
    } else if (diffSeconds <= 300) { // 5 minutes
      return '<span class="status-dot yellow" title="Warning"></span>';
    } else {
      return '<span class="status-dot red" title="Offline"></span>';
    }
  }

  function getStatusText(scope: any): string {
    if (!scope.lastHeartbeatAt) {
      return '';
    }

    const lastHeartbeat = new Date(scope.lastHeartbeatAt);
    const timeAgo = formatTimeAgo(lastHeartbeat);
    let status = `Last seen ${timeAgo}`;
    
    if (scope.lastRunIndex !== undefined && scope.totalRuns !== undefined) {
      status = `Run ${scope.lastRunIndex} / ${scope.totalRuns} — ${status}`;
    } else if (scope.lastRunIndex !== undefined) {
      status = `Run ${scope.lastRunIndex} — ${status}`;
    }
    
    return status;
  }

  async function loadScopes() {
    const container = document.getElementById('scopes-container');
    if (!container) return;

    try {
      const response = await fetch('/api/scopes');
      const data = await response.json();

      if (!data.scopes || data.scopes.length === 0) {
        container.innerHTML = '<p>You haven\'t added any scopes yet.</p>';
        return;
      }

      const scopeList = document.createElement('ul');
      scopeList.className = 'scope-list';

      for (const scope of data.scopes) {
        const li = document.createElement('li');
        li.className = 'scope-item';
        
        const dishSizeFormatted = formatDishSize(scope.dishSizeMm, 'mm');
        const dishSizeInches = formatDishSize(scope.dishSizeMm, 'inches');
        const statusDot = getStatusDot(scope);
        const statusText = getStatusText(scope);

        li.innerHTML = `
          <div class="scope-info">
            <h3>${statusDot} ${escapeHtml(scope.name)}</h3>
            <p>Location: ${scope.latitude.toFixed(4)}°, ${scope.longitude.toFixed(4)}° (${escapeHtml(scope.country)})</p>
            <p>Dish: ${dishSizeFormatted} (${dishSizeInches})</p>
            ${statusText ? `<p class="scope-status">${statusText}</p>` : ''}
          </div>
          <div class="scope-actions">
            <a href="/scopes/${scope._id}">View</a>
            <button onclick="deleteScope('${scope._id}', '${escapeHtml(scope.name)}')">Delete</button>
          </div>
        `;
        
        scopeList.appendChild(li);
      }

      container.innerHTML = '';
      container.appendChild(scopeList);
    } catch (error) {
      console.error('Error loading scopes:', error);
      container.innerHTML = '<p>Failed to load scopes.</p>';
    }
  }

  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  (window as any).deleteScope = async function(id: string, name: string) {
    if (!confirm(`Delete scope "${name}"?`)) return;

    try {
      const response = await fetch(`/api/scopes/${id}`, {
        method: 'DELETE',
      });

      if (response.ok) {
        loadScopes();
      } else {
        alert('Failed to delete scope');
      }
    } catch (error) {
      console.error('Error deleting scope:', error);
      alert('Failed to delete scope');
    }
  };

  loadScopes();
</script>

